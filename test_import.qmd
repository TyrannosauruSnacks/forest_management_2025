---
title: "test_import"
format: html
editor: visual
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Prerequisites
```{r setup}
library(tidyverse)
library(readr)
set_theme(theme_light())
```

## Import and tidy data
```{r}
results_bas <-
    read_delim(
      "data/bas_results.txt", 
      delim = "\t", escape_double = FALSE,
      show_col_types = FALSE,
      trim_ws = TRUE
      )

results_siafi <- 
    read_delim(
      "data/siafi_results.txt", 
      delim = "\t", escape_double = FALSE, 
      show_col_types = FALSE,
      trim_ws = TRUE
      )

results_he <- 
    read_delim(
      "data/he_results.txt", 
      delim = "\t", escape_double = FALSE, 
      show_col_types = FALSE,
      trim_ws = TRUE
      )

results <- 
  bind_rows(
    list(
      bas   = results_bas,
      he    = results_he,
      siafi = results_siafi),
    .id = "strategy") |> 
  janitor::clean_names() |> 
  select(-bestand)
```


```{r}
parameters <- 
  c(
    g_wert_l    = "Economic yield (€)",
    wert_a      = "Net realizable value, harvested (€)",
    artprofil   = "mod. Shannon-Index",
    wert_v      = "Net realizable value, standing (€)"
  )

results |> 
  filter(baumart == "Alle Arten") |> 
  select(strategy, periode, baumart,
           wert_a, wert_v, g_wert_l, artprofil) |>
  mutate(
    g_wert_l = case_when(strategy == "bas" ~ wert_v,
                          TRUE ~ g_wert_l),
    periode  = (periode - 1) * 5,
    strategy = str_to_upper(strategy)) |> 
  pivot_longer(wert_a:artprofil,
               names_to  = "parameter",
               values_to = "value") |> 
  ggplot(aes(periode, value, linetype = strategy, color = strategy)) +
  geom_line(linewidth = .66) +
  # scale_y_continuous(labels = scales::label_currency(prefix = "€"),
  #                    breaks = scales::breaks_extended(10)) +
  labs(
    y        = "Value",
    x        = "Elapsed years",
    color    = "Silvic strategy",
    linetype = "Silvic strategy"
  ) +
  scale_color_discrete(palette = "set2") +
  scale_y_continuous(labels = scales::label_comma()) +
  theme(text = element_text(size   = 10,
                            family = "DejaVu Serif")) +
  facet_wrap(~parameter, scales = "free",
             labeller = labeller(parameter = parameters))


ggsave("~/Nextcloud/1_projects/Forest_Management_Group/images/plot_results.png",
       units = "mm",
       height = 210/2,
       width = (210 * (16/9))/2
       )
```

Reducing the BAS strategy with the lost winnings from not selling the thinnings.
```{r}
results |> 
  filter(baumart == "Alle Arten") |> 
  group_by(strategy) |> 
  summarise(
    n = n(),
    thinning_win = sum(wert_a),
    g_wert_l = max(g_wert_l)) |> 
  mutate(g_wert_real = if_else(strategy == "bas", g_wert_l - thinning_win, g_wert_l))
```
